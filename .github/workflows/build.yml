name: Build gmpy2 for Android Python 3.11

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Build and patch gmpy2
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          
          install: |
            apt-get update -q -y
            apt-get install -q -y python3.11 python3.11-dev python3-pip gcc make \
              libgmp-dev libmpfr-dev libmpc-dev patchelf tar
            python3.11 -m pip install --upgrade pip
          
          run: |
            # Устанавливаем gmpy2
            python3.11 -m pip install gmpy2
            
            # Находим где установлен
            GMPY2_PATH=$(python3.11 -c "import gmpy2, os; print(os.path.dirname(gmpy2.__file__))")
            echo "Found gmpy2 at: $GMPY2_PATH"
            
            cd $GMPY2_PATH
            
            # Показываем исходные зависимости
            echo "=== BEFORE PATCHING ==="
            readelf -d gmpy2.cpython-311-aarch64-linux-gnu.so | grep NEEDED || true
            
            # Патчим библиотеки
            echo "=== PATCHING ==="
            patchelf --replace-needed libmpc-1e370dba.so.3.3.1 libmpc.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            patchelf --replace-needed libmpfr-0cf6192b.so.6.2.2 libmpfr.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            patchelf --replace-needed libgmp-5fe5a0bb.so.10.5.0 libgmp.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            patchelf --replace-needed libm.so.6 libm.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            patchelf --replace-needed libpthread.so.0 libpthread.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            patchelf --replace-needed libc.so.6 libc.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            
            # Удаляем системные библиотеки
            echo "=== REMOVING SYSTEM LIBS ==="
            patchelf --remove-needed libm.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            patchelf --remove-needed libpthread.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            patchelf --remove-needed libc.so gmpy2.cpython-311-aarch64-linux-gnu.so || true
            
            # Показываем результат
            echo "=== AFTER PATCHING ==="
            readelf -d gmpy2.cpython-311-aarch64-linux-gnu.so | grep NEEDED || true
            
            # Копируем библиотеки из системы
            cp /usr/lib/aarch64-linux-gnu/libgmp.so.10 libgmp.so
            cp /usr/lib/aarch64-linux-gnu/libmpfr.so.6 libmpfr.so
            cp /usr/lib/aarch64-linux-gnu/libmpc.so.3 libmpc.so
            
            # Архивируем
            cd ..
            tar -czf /tmp/gmpy2-android-patched.tar.gz gmpy2/
            cp /tmp/gmpy2-android-patched.tar.gz ${GITHUB_WORKSPACE}/
            
            echo "=== DONE ==="
            ls -lh ${GITHUB_WORKSPACE}/gmpy2-android-patched.tar.gz
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gmpy2-android-python3.11-patched
          path: gmpy2-android-patched.tar.gz
